{"version":3,"file":"single-spa.js","sources":["../../src/applications/app.helpers.js","../../src/lifecycles/bootstrap.js","../../src/lifecycles/load.js","../../src/lifecycles/mount.js","../../src/lifecycles/unmount.js","../../src/start.js","../../src/navigations/navigator-events.js","../../src/navigations/reroute.js","../../src/applications/app.js"],"sourcesContent":["export const NOT_LOADED = 'NOT_LOADED';\r\nexport const LOADING_SOURCE_CODE = 'LOADING_SOURCE_CODE';\r\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED';\r\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING';\r\nexport const NOT_MOUNTED = 'NOT_MOUNTED';\r\nexport const MOUNTING = 'MOUNTING';\r\nexport const MOUNTED = 'MOUNTED';\r\nexport const UNLOADING = 'UNLOADING';\r\nexport const UNMOUNTING = 'UNMOUNTING';\r\nexport const UPDATEING = 'UPDATEING';\r\nexport const LOAD_ERROR = 'LOAD_ERROR';\r\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN';\r\n\r\n\r\nexport function isActive(app) {\r\n    return app.status === MOUNTED\r\n}\r\n\r\nexport function shouldBeActive(app) {\r\n    return app.activeWhen(window.location)\r\n}\r\n","import { BOOTSTRAPPING, NOT_BOOTSTRAPPED, NOT_MOUNTED } from \"../applications/app.helpers\";\r\n\r\nexport async function toBootstrapPromise(app) {\r\n    if (app.status !== NOT_BOOTSTRAPPED) {\r\n        return app;\r\n    }\r\n    app.status = BOOTSTRAPPING;\r\n    await app.bootstrap(app.customProps);\r\n    app.status = NOT_MOUNTED;\r\n    return app;\r\n}","import { LOADING_SOURCE_CODE, NOT_BOOTSTRAPPED } from \"../applications/app.helpers\";\r\n\r\nfunction flattenFnArray(fns) {\r\n    fns = Array.isArray(fns) ? fns : [fns];\r\n    // 通过promise链来链式调用  多个方法组合成一个方法\r\n    // Promise.resolve().then(()=>fn1(props)).then(()=>fn2(props))\r\n    return (props) => fns.reduce((p, fn) => p.then(() => fn(props)), Promise.resolve())\r\n    // return (props) => fns.reduce((p, fn) => {\r\n    //     console.log(props)\r\n    //     console.log(p)\r\n    //     console.log(fn)\r\n    //     p.then(() => fn(props))\r\n    // }, Promise.resolve());\r\n}\r\n\r\n\r\nexport async function toLoadPromise(app) {\r\n    if (app.loadPromise) {\r\n        return app.loadPromise;  // 缓存机制， 防止重复\r\n    }\r\n    return (app.loadPromise = Promise.resolve().then(async () => {\r\n        app.status = LOADING_SOURCE_CODE;\r\n        let { bootstrap, mount, unmount } = await app.loadApp(app.customProps)\r\n        app.status = NOT_BOOTSTRAPPED;\r\n        app.bootstrap = async () => { };\r\n        app.bootstrap = flattenFnArray(bootstrap);\r\n        app.mount = flattenFnArray(mount);\r\n        app.unmount = flattenFnArray(unmount);\r\n        delete app.loadPromise;\r\n        return app;\r\n    }))\r\n}","import { MOUNTED, MOUNTING, NOT_MOUNTED } from \"../applications/app.helpers\";\r\n\r\nexport async function toMountPromise(app) {\r\n    if (app.status !== NOT_MOUNTED) {\r\n        return app;\r\n    }\r\n    app.status = MOUNTING;\r\n    await app.mount(app.customProps);\r\n    app.status = MOUNTED;\r\n    return app;\r\n}","import { MOUNTED, NOT_MOUNTED, UNMOUNTING } from \"../applications/app.helpers\";\r\n\r\nexport async function toUnmountPromise(app) {\r\n    if (app.status != MOUNTED) {\r\n        return app;\r\n    }\r\n    app.status = UNMOUNTING;\r\n    await app.unmount(app.customProps)\r\n    app.status = NOT_MOUNTED;\r\n    return app;\r\n}","import { reroute } from \"./navigations/reroute\";\r\nexport let started = false;\r\nexport function start() {\r\n    // 除了加载，需要挂载应用\r\n    started = true;\r\n    reroute();\r\n}","// hashchange <- hash 模式\r\n// popstate <- history 模式\r\n\r\nimport { reroute } from \"./reroute\"\r\n\r\nexport const routingEventsListeningTo = ['hashchange', 'popstate']\r\nfunction urlReroute() {\r\n    reroute([], arguments);\r\n}\r\nconst captureEventListeners = {\r\n    hashChange: [],\r\n    popstate: []  // 应用切换完成后会调用\r\n}\r\n// 绑定 路由改变的事件\r\nwindow.addEventListener('hashchange', urlReroute)\r\nwindow.addEventListener('popstate', urlReroute)\r\n\r\n// 缓存 hashchange 和 popstate , 自定义绑定的事件\r\nconst originalAddEventListener = window.addEventListener;\r\nconst originalRemoveEventListener = window.removeEventListener;\r\n\r\nwindow.addEventListener = function (eventName, fn) {\r\n    if (routingEventsListeningTo.indexOf(eventName) >= 0\r\n        && captureEventListeners[eventName] && !captureEventListeners[eventName].some(listener => listener == fn)) {\r\n        captureEventListeners[eventName].push(fn); // 暂存进来\r\n        return;\r\n    }\r\n    return originalAddEventListener.apply(this, arguments);\r\n}\r\nwindow.removeEventListener = function (eventName, fn) { // 还原\r\n    if (routingEventsListeningTo.indexOf(eventName) >= 0) {\r\n        captureEventListeners[eventName] = captureEventListeners[eventName].filter(l => l !== fn);\r\n        return;\r\n    }\r\n    return originalRemoveEventListener.apply(this, arguments);\r\n}\r\n// 处理 用户 js 调用 window.history 修改事件\r\nfunction patchedUpdateState(updateState, methodName) {\r\n    return function () {\r\n        const urlBefore = window.location.href;\r\n        updateState.apply(this, arguments); // 调用切换的方法\r\n        const urlAfter = window.location.href;\r\n        if (urlBefore !== urlAfter) {\r\n            urlReroute(new PopStateEvent('popstate')); // 新产生一个事件 popstate \r\n        }\r\n    }\r\n}\r\nwindow.history.pushState = patchedUpdateState(window.history.pushState, 'pushState');\r\nwindow.history.replaceState = patchedUpdateState(window.history.replaceState, 'replaceState');","import { getAppChanges } from \"../applications/app\";\r\nimport { toBootstrapPromise } from \"../lifecycles/bootstrap\";\r\nimport { toLoadPromise } from \"../lifecycles/load\";\r\nimport { toMountPromise } from \"../lifecycles/mount\";\r\nimport { toUnmountPromise } from \"../lifecycles/unmount\";\r\nimport { started } from \"../start\";\r\nimport './navigator-events';\r\n\r\nexport function reroute() {\r\n    const { appsToUnmount, appsToMount, appsToLoad } = getAppChanges()\r\n    // start 和 registerApplication 加载了两次\r\n    if (started) {\r\n        // app 装载\r\n        return performanceAppChanges();\r\n    } else {\r\n        // 注册应用，进行预先加载\r\n        return loadApps();\r\n    }\r\n\r\n    async function performanceAppChanges() {\r\n        // Promise.all 暂时不写了\r\n        let unmountPromises = appsToUnmount.map(toUnmountPromise);\r\n        appsToLoad.map(async (app) => {\r\n            // 无时无刻都要根据路由来判断 app 的生命周期，所以在 这些函数内部应该都要做一些判断\r\n            app = await toLoadPromise(app);\r\n            app = await toBootstrapPromise(app);\r\n            return toMountPromise(app);\r\n        })\r\n        appsToMount.map(async (app) => {\r\n            app = await toBootstrapPromise(app);\r\n            return toMountPromise(app);\r\n        })\r\n    }\r\n    async function loadApps() {\r\n        let apps = await Promise.all(appsToLoad.map(toLoadPromise));\r\n    }\r\n}","import { BOOTSTRAPPING, LOADING_SOURCE_CODE, MOUNTED, MOUNTING, NOT_BOOTSTRAPPED, NOT_LOADED, NOT_MOUNTED, shouldBeActive } from \"./app.helpers\";\r\nimport { reroute } from \"../navigations/reroute\";\r\n/**\r\n * 不写返回值了，也不做校验了\r\n * @param {*} appName xxx\r\n * @param {*} loadApp xxx\r\n * @param {*} activeWhen xxx\r\n * @param {*} customProps xxx\r\n */\r\nconst apps = [];\r\nexport function registerApplication(appName, loadApp, activeWhen, customProps) {\r\n    apps.push({  // 注册完毕\r\n        name: appName,\r\n        loadApp,\r\n        activeWhen,\r\n        customProps,\r\n        status: NOT_LOADED    // 应用的生命周期\r\n    });\r\n    reroute(); // 加载应用\r\n}\r\n\r\nexport function getAppChanges() {\r\n    const appsToUnmount = [];\r\n    const appsToMount = [];\r\n    const appsToLoad = [];\r\n    apps.forEach(app => {\r\n        // 先不考虑出错了\r\n        // const appShouldBeActive = app.status !== SKIP_BECAUSE_BROKEN && shouldBeActive(app)\r\n        const appShouldBeActive = shouldBeActive(app)\r\n        switch (app.status) {\r\n            case NOT_LOADED:\r\n            case LOADING_SOURCE_CODE:\r\n                if (appShouldBeActive) {\r\n                    appsToLoad.push(app)\r\n                }\r\n                break;\r\n            case NOT_MOUNTED:\r\n            case NOT_BOOTSTRAPPED:\r\n            case BOOTSTRAPPING:\r\n                if (appShouldBeActive) {\r\n                    appsToMount.push(app)\r\n                }\r\n                break;\r\n            case MOUNTING:\r\n            case MOUNTED:\r\n                if (appShouldBeActive) {\r\n                    appsToUnmount.push(app)\r\n                }\r\n                break;\r\n        }\r\n    })\r\n    return { appsToUnmount, appsToMount, appsToLoad }\r\n}"],"names":[],"mappings":"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"}